'use strict';var container=document.getElementById('activist-army-container'),userDataForm=document.getElementById('activist-user-info'),emailTemplate=document.getElementById('email-template'),state={userInfo:{},candidates:[]};function setState(a){Object.keys(a).forEach(function(b){state[b]=a[b]})}userDataForm.addEventListener('submit',function(a){a.preventDefault(),state.userInfo.name=a.target[0].value,state.userInfo.email=a.target[1].value,showLoader(),fetch('/api?postcode='+a.target[2].value).then(function(b){if(200!==b.status){throw new Error('Invalid postcode')}return b.json()}).then(function(b){return hideLoader(),listCandidates(b)}).then(setState).then(makeForm).catch(function(b){hideLoader(),showError(b)}),userDataForm.style.display='none'});function create(a,b){var d=document.createElement(a);return d.className=b,d}function showError(a){var b=create('p','activist-error');b.innerText=a.message,userDataForm.style.display='initial',container.appendChild(b)}function listCandidates(a){return hideLoader(),emailTemplate.style.display='inherit',console.log(a),a.forEach(function(b){var d=create('label','activist-candidate__card-label');d.for='checkboxBox';var f=create('article','activist-candidate'),g=create('img','activist-candidate__photo');g.src=b.photo||'./profile_blank.png',g.alt='picture of '+b.name;var h=create('h2','activist-candidate__name');h.innerText=b.name;var j=create('h3','activist-candidate__party');j.innerText=b.party;var k;b.email?(k=create('label','activist-candidate__label'),checkboxBox=create('input','activist-candidate__checkbox'),k.innerText='Send email: ',checkboxBox.type='checkbox',f.className+=' activist-candidate--selected',checkboxBox.checked=!0,checkboxBox.value=b.email,checkboxBox.addEventListener('change',checkboxHandler),k.appendChild(checkboxBox)):(k=create('p','activist-candidate__no-email'),k.innerText='No email'),f.appendChild(g),f.appendChild(h),f.appendChild(j),f.appendChild(k),d.appendChild(f),container.appendChild(d)}),normaliseHeights(document.querySelectorAll('.activist-candidate')),{candidates:a.map(function(b){return{name:b.name,party:b.party,email:b.email,photo:b.photo,checked:!!b.email}})}}function checkboxHandler(a){var b=state.candidates.findIndex(function(f){return f.email===a.target.value}),d=a.target.parentElement.parentElement;a.target.checked?d.classList.add('activist-candidate--selected'):d.classList.remove('activist-candidate--selected'),setState({candidates:state.candidates.map(function(f,g){return g===b?{name:f.name,email:f.email,party:f.party,photo:f.photo,checked:a.target.checked}:f})}),state.candidates.every(function(f){return!f.checked})?document.getElementById('activist-send').classList.add('activist-send--disabled'):document.getElementById('activist-send').classList.remove('activist-send--disabled')}var makeForm=function(){var a=create('button','button');a.innerText='Send emails',a.id='activist-send',state.candidates.every(function(d){return!d.checked})&&a.classList.add('activist-send--disabled');var b=create('textarea','activist--user-contribution');b.placeholder='Anything you want to add?',container.appendChild(a),container.appendChild(b),a.addEventListener('click',function(d){if(d.preventDefault(),state.candidates.some(function(g){return g.checked})){var f=state.candidates.filter(function(g){return g.checked}).map(function(g){return{email:g.email,name:g.name}});showLoader('Sending emails...'),sendEmails(f,{email:state.userInfo.email,name:state.userInfo.name},b.value).then(emailSent).catch(emailError)}})};function emailSent(){document.getElementById('activist-army-start').scrollIntoView(),container.innerHTML='',emailTemplate.style.display='none';var a=create('h2'),b=create('h3');a.innerText='Emails successfully sent',b.innerText='Thanks for supporting The Big Issue!',a.appendChild(b),container.appendChild(a)}function emailError(a){if(document.getElementById('activist-army-start').scrollIntoView(),container.innerHTML='',emailTemplate.style.display='none',console.log(a),a.error&&-1===a.error.findIndex(function(g){return 0===g.ErrorCode})){var b=create('h2');b.innerText='Error';var d=create('p');d.id='activist-email-error',d.innerText='The email delivery failed. ';var f=create('a');f.href='#',f.innerText='Click here to try again.',d.appendChild(f),f.addEventListener('click',function(g){g.preventDefault(),window.location.reload()}),container.appendChild(b),container.appendChild(d)}else emailSent()}function sendEmails(a,b,d){return new Promise(function(f,g){fetch('/api',{method:'POST',body:JSON.stringify({emails:[{email:'finnhodgkin@gmail.com',name:'Finn'},{email:'zooeyxmiller@gmail.com',name:'zooey'}],fromEmail:b,userInput:d})}).then(function(h){return hideLoader(),h.json()}).then(g).catch(function(h){return hideLoader(),console.log('happening'),f(h)})})}function showLoader(a){var b=document.getElementById('activist-loading-container');b.classList.add('activist-loading-container--show'),a&&(b.querySelector('#activist-loading').innerText=a)}function hideLoader(){document.getElementById('activist-loading-container').classList.remove('activist-loading-container--show')}var normaliseHeights=function(a){var b=Math.max.apply(null,Array.from(a).map(function(d){return d.clientHeight}));a.forEach(function(d){return d.style.height=b+18+'px'})};
